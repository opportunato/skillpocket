$ ->

  if $('.poll').length > 0

    getToken = ->
      document.querySelector('input[name="authenticity_token"]').value

    openPage = (id) ->
      $(".page").addClass('hidden')
      $(".page#{id}").removeClass('hidden')

    getCurrentId = ->
      $(".page:not(.hidden)").data('currentId')

    getCurrentPage = ->
      $(".page:not(.hidden)")

    sendForm = (e) ->

      currentId = getCurrentId()
      data = getCurrentPage().find('form').serialize() + "&page=" + currentId

      openPage(currentId + 1)

      $.ajax
        type: "POST",
        url: '<%= prelaunch_submit_path %>',
        headers: {
          "X-CSRF-TOKEN": getToken()
          "X-Requested-With": 'XMLHttpRequest'
        },
        data: data,
        dataType: 'json'

    $(document).on 'keydown', (e) ->
      if e.keyCode == 13 && getCurrentId() != 3
        e.preventDefault()
        sendForm()

    $('a.button').on 'click', (e) ->
      e.preventDefault()
      sendForm()
